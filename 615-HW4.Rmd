---
title: "615-HW4"
author: "Gary Wang"
date: "2024-09-25"
output: pdf_document
---

```{r}
library(data.table)
library(lubridate)
library(ggplot2)
library(dplyr)
```

a
```{r}
# function to load buoy data for a given year
load_buoy <- function(year) {
  base_url <- "https://www.ndbc.noaa.gov/view_text_file.php?filename=44013h"
  suffix <- ".txt.gz&dir=data/historical/stdmet/"
  file_url <- paste0(base_url, year, suffix)
  
  # skip header lines based on year
  skip <- ifelse(year < 2007, 1, 2)
  
  # read column names
  headers <- scan(file_url, what = 'character', nlines = 1)
  
  # load the dataset with fill to handle missing columns
  buoy <- fread(file_url, header = FALSE, skip = skip, fill = TRUE)
  
  # adjust columns to match header count
  if (ncol(buoy) > length(headers)) {
    buoy <- buoy[, 1:length(headers), with = FALSE]
  } else if (ncol(buoy) < length(headers)) {
    for (i in 1:(length(headers) - ncol(buoy))) {
      buoy[, paste0("V", ncol(buoy) + i) := NA]
    }
  }
  
  # assign column names
  setnames(buoy, headers)
  
  # combine date and time into a single column
  buoy$datetime <- make_datetime(
    year = as.integer(buoy$YYYY), 
    month = as.integer(buoy$MM), 
    day = as.integer(buoy$DD), 
    hour = as.integer(buoy$hh), 
    min = as.integer(buoy$mm)
  )
  
  return(buoy)
}

# define years range
years <- 1985:2023

# load data for each year
buoy_list <- lapply(years, load_buoy)

# combine all yearly data
combined_buoy <- rbindlist(buoy_list, fill = TRUE)

fwrite(combined_buoy, "buoy_data.csv")
```

b
```{r}
buoy_data <- fread("buoy_data.csv")

# convert placeholder values to NA
missing_values <- c(999, 99.9, 9999)  

# specify columns that may contain these placeholder values
columns_to_check <- c("WDIR", "WSPD", "GST", "WVHT", "APD", "MWD", 
                      "PRES", "ATMP", "WTMP", "DEWP", "VIS") 

# iterate over the columns and replace only the specified placeholders with NA
for (col in columns_to_check) {
  buoy_data[[col]] <- ifelse(buoy_data[[col]] %in% missing_values, NA, buoy_data[[col]])
}

# analyze the pattern of NAs
na_summary <- sapply(buoy_data, function(x) sum(is.na(x)))
print(na_summary)

# display a sample of the data to ensure correct replacements
head(buoy_data)

# Converting missing/null data to NA is not always a good idea. Because the placeholder values, such as 999, can carry specific information like sensor malfunctions and so on, which is crucial for the better understanding of the dataset.
# The NA values appear to be distributed in a structured way as they clustered around certain variables and dates, which suggests data recording issues or planned outages rather than isolated, random gaps.
```

c
```{r}
buoy_data$year <- year(buoy_data$datetime)

# Calculate annual averages for ATMP, WTMP, and PRES
annual_avg <- buoy_data[, .(avg_ATMP = mean(ATMP, na.rm = TRUE),
                            avg_WTMP = mean(WTMP, na.rm = TRUE)), by = year]

# Plotting air and water temperature trends
ggplot(annual_avg, aes(x = year)) +
  geom_line(aes(y = avg_ATMP, color = "air temp")) +
  geom_line(aes(y = avg_WTMP, color = "water temp")) +
  labs(x = "year", y = "temperature")

# linear regression to find trends
model_ATMP <- lm(avg_ATMP ~ year, data = annual_avg)
model_WTMP <- lm(avg_WTMP ~ year, data = annual_avg)

# summary of regression models
summary_ATMP <- summary(model_ATMP)
summary_WTMP <- summary(model_WTMP)

print(summary_ATMP)
print(summary_WTMP)
```

d
```{r}
rainfall_data <- fread("Rainfall.csv")

# inspect the structure of the data
str(rainfall_data)
summary(rainfall_data)

# check for missing values
colSums(is.na(rainfall_data))

# convert date to date-time format
rainfall_data$Date <- as.POSIXct(rainfall_data$DATE, format = "%Y%m%d %H:%M", tz = "UTC")

# calculate summary statistics for rainfall
rainfall_stats <- rainfall_data %>%
  summarise(
    mean_rainfall = mean(HPCP, na.rm = TRUE),
    median_rainfall = median(HPCP, na.rm = TRUE),
    max_rainfall = max(HPCP, na.rm = TRUE),
    min_rainfall = min(HPCP, na.rm = TRUE)
  )

print(rainfall_stats)

# plot rainfall distribution
ggplot(rainfall_data, aes(x = HPCP)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Rainfall in Boston (1985-2013)", 
       x = "rainfall", y = "frequency")

# plot time series of rainfall
ggplot(rainfall_data, aes(x = Date, y = HPCP)) +
  geom_line(color = "blue") +
  labs(title = "Rainfall Over Time in Boston (1985-2013)",
       x = "Year", y = "rainfall")

# merge datasets by date
rainfall_buoy <- merge(rainfall_data, buoy_data, by.x = "Date", by.y = "datetime")

# explore relationships between rainfall (HPCP) and buoy readings
ggplot(rainfall_buoy, aes(x = WTMP, y = HPCP)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Water Temperature vs Rainfall",
         x = "water temperature", y = "rainfall")

# Yes, this exercise shows just how tough forecasting really is. With messy data, sensor glitches, and the sheer unpredictability of weather, it’s no wonder forecasts aren’t always spot-on. It’s a constant battle with imperfect information and chaotic patterns, making me appreciate how much effort goes into those daily predictions—even when they don’t always get it right.
```
